# Описание протокола
## 1.1 Формат протокола передачи команд
Связь контрольно-кассовой техники (далее ККТ) с компьютером осуществляется по интерфейсу RS232 или USB в режиме виртуального COM порта. Параметры COM порта по умолчанию - 57600,n,8,1.  
Взаимодействие между кассовой программой (далее КП) инициируется со стороны КП: КП посылает командное сообщение (команду), а ККТ всегда посылает ответное сообщение (ответ). Взаимодействие КП с ККТ может осуществляться в двух режимах: синхронном и асинхронном. В синхронном режиме компьютер посылает команду и ждет ответ на него. После получения ответа компьютер посылает следующую команду. Взаимодействие в синхронном режиме может осуществляться без использования линий аппаратного квитирования (DTR/DSR, CTS/RTS). В асинхронном режиме компьютер посылает командные сообщения и принимает ответные сообщения в произвольной последовательности. Взаимодействие в этом режиме должно осуществляться с использованием линий аппаратного квитирования CTS/RTS.  
Взаимодействие ККТ с техническими средствами ОФД (далее ТС ОФД) осуществляется по протоколу TCP/IP. Инициатором отправки фискальных данных в ТС ОФД всегда выступает ККТ. Взаимодействие ККТ с ТС ОФД подробно изложено в описании протокола взаимодействия между ККТ и информационной (автоматизированной) системой оператора  фискальных данных, введенной в действие ФНС России 01.04.2016 
 
**Пакет команды со стороны КП**

1 | 2 | 3 | 4 | 5 | 6 | 7  
--- | --- | --- | --- | --- | --- | ---
STX | Пароль связи | ID пакета | Код команды | Данные | ETX | CRC  

**Пакет ответа со стороны ККТ**

1 | 2 | 3 | 4 | 5 | 6 | 7   
--- | --- | --- | --- | --- | --- | ---
STX | ID пакета | Код команды | Код ошибки | Данные | ETX | CRC  

  * STX - байт начала пакета (0x02).  
  * ETX - байт окончания пакета (0x03).  
  * CRC - контрольная сумма пакета. Контрольная сумма подсчитывается по алгоритму: выполнение операции XOR для всех байт блока, включая ETX, но исключая STX. Данные контрольной суммы занимают два байта и являются символьным представлением числа в шестнадцатеричной системе исчисления.  
  * ID пакета - идентификатор пакета. Произвольный байт, имеющий код в промежутке между 0x20 и 0xF0. ID пакета в ответе на команду, всегда совпадает с ID пакета команды. Может использоваться для синхронизации пакета команды и ответа на нее в условиях многозадачности в приложении или в асинхронном режиме.  
  * Пароль связи - четырехбайтовый пароль, предназначенный для ограничения возможности несанкционированной работы с ККТ. Пароль по умолчанию - ”PIRI”.  
  * Код команды - два байта, представляющие собой код команды в шестнадцатеричном исчислении, т.е. если код команды равен 0x21, необходимо передать два символа в виде – «21».  
  * Код ошибки - два байта, с символьным представлением числа в шестнадцатеричном исчислении. Поле содержит число «00» в случае успешного выполнения команды или код ошибки.  
  * Данные - параметры команды, или ответа на команду, разделенные между собой символом FS (0x1C).  Количество передаваемых и возвращаемых параметров зависит от кода конкретной команды.

## 1.2 Специальные команды.
Специальные команды протокола состоят из одного байта в двоичном формате, без заголовка, концовки и контрольной суммы.

### 1.2.1 Проверка связи с ККТ
Для проверки связи с ККТ существует специальная команда:  
0x05 (ENQ) – проверка связи.  
Ответ состоит тоже из одного байта:  
0x06 (ACK) – ККТ на связи.  
Если в момент проверки связи ККТ передает данные в ответ на другую команду, то ответ может быть получен только после завершения этой передачи.
 
### 1.2.3 Промотка бумаги
Для промотки бумаги в ККТ существует специальная команда:  
0x0A (LF) – промотать бумагу на одну строку.

## 1.3 Времена ожидания
В протоколе обмена данными между ККТ и КП предусмотрены следующие времена ожидания:  
1. Время ожидания приема между байтами пакета информации – 200 мс. По истечении данного промежутка времени возвращается код ошибки передачи.  
2. Время ожидания ответа от ККТ - зависит от выполняемой ККТ в данный момент операции. Для принятия решения о неисправности ККТ (коммуникационного порта или кабеля передачи данных) необходимо использовать команду “Проверка связи с ККТ”.  
3. Таймер ФН Период издания Клиентом ККТ события «Таймер ФН». Значение длительности таймера может находится в пределах от 0 секунд (непрерывный программный цикл) до 60 секунд. Длительность таймера – фиксированная и составляет 30 секунд.  
4. Таймер С! В этом состоянии Клиент ККТ взводит таймер на ожидание повторной попытки установления соединения транспортного уровня (событие «Таймер С»). Период издания Клиентом ККТ события «Таймер С» устанавливается в диапазоне от 0 секунд (непрерывный программный цикл) до 3600 секунд. Длительность таймера составляет 60 секунд.

# 2. Основные типы передаваемых параметров
 
## 2.1 Строка
Любая последовательность символов, с кодами от 0x20 до 0xF0. Длина конкретной строки зависит от значения передаваемого параметра. Может иметь нулевую длину (пустая строка).  Для печати символов на русском языке необходимо использовать кодировку CP866.

## 2.2 Дата
Строка длиной 6 символов вида «ДДММГГ», где:  
ДД	- день месяца;  
ММ	- номер месяца в году;  
ГГ	- последние две цифры года.  
Все числа передаются с точностью до 2-х цифр, если число меньше 10-ти, то добавляется старший ноль.

## 2.3 Время
Строка длиной 6 символов вида «ЧЧММСС», где:  
ЧЧ	- часы;  
ММ	- минуты;  
СС	- секунды.  
Все числа передаются с точностью до 2-х цифр, если число меньше 10-ти, то добавляется старший ноль.
 
## 2.4 Целое число
Строка состоящая только из цифр, и представляющей собой целое число в десятеричной системе исчисления. Пустая строка интерпретируется как ноль. Используется для передачи номеров, индексов, битовых масок(полей) и т.д.
 
### 2.5 Дробное число
Строка состоящая из цифр, десятичной точки и знака «-». Пустая строка интерпретируется как ноль. Используется для передачи суммы, количества и процентных ставок. Рекомендуется передавать суммы с точностью 2 знака после десятичной точки (с точностью до копейки), процентные ставки с точностью до 4-х знаков после десятичной точки и количество до 9-ти знаков после десятичной точки.
 
## 2.6 Имя оператора
Строка размером 0...64 символа. Если необходимо передать ИНН кассира, то его следует передать первыми и отделить символом '&', например:
 
> 112233445566&Васильева О.Е.